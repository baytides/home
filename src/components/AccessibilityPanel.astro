---
// Accessibility Panel Component
// WCAG 2.2 AAA compliant controls for display preferences
---

<!-- Accessibility Toggle Button -->
<button
  class="accessibility-toggle"
  id="accessibility-toggle"
  type="button"
  aria-label="Open accessibility settings"
  aria-expanded="false"
  aria-controls="accessibility-panel"
>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    aria-hidden="true"
  >
    <circle cx="12" cy="4.5" r="2.5"></circle>
    <path d="M12 7v6"></path>
    <path d="M8 11h8"></path>
    <path d="M10 21l2-4 2 4"></path>
    <path d="M10 17h4"></path>
  </svg>
</button>

<!-- Accessibility Panel -->
<div
  class="accessibility-panel"
  id="accessibility-panel"
  role="dialog"
  aria-label="Accessibility settings"
  aria-hidden="true"
>
  <div class="panel-header">
    <h3>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        aria-hidden="true"
      >
        <circle cx="12" cy="4.5" r="2.5"></circle>
        <path d="M12 7v6"></path>
        <path d="M8 11h8"></path>
        <path d="M10 21l2-4 2 4"></path>
        <path d="M10 17h4"></path>
      </svg>
      Accessibility
    </h3>
    <button type="button" class="panel-close" id="panel-close" aria-label="Close panel">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="18"
        height="18"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M18 6L6 18"></path>
        <path d="M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <div class="panel-content">
    <div class="panel-section">
      <div class="panel-section-title">Vision</div>
      <label>
        <input type="checkbox" id="high-contrast-toggle" />
        High Contrast
      </label>
      <div class="text-size-control">
        <span class="text-size-label">Text Size</span>
        <div class="text-size-adjuster">
          <button
            type="button"
            class="size-btn"
            id="text-size-decrease"
            aria-label="Decrease text size"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
          <span class="text-size-value" id="text-size-value" aria-live="polite">100%</span>
          <button
            type="button"
            class="size-btn"
            id="text-size-increase"
            aria-label="Increase text size"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <div class="panel-section-title">Motion</div>
      <label>
        <input type="checkbox" id="reduced-motion-toggle" />
        Reduce Motion
      </label>
    </div>

    <div class="panel-section">
      <div class="panel-section-title">Reading</div>
      <label>
        <input type="checkbox" id="text-spacing-toggle" />
        Increase Text Spacing
      </label>
      <label>
        <input type="checkbox" id="underline-links-toggle" />
        Underline All Links
      </label>
    </div>

    <div class="panel-section">
      <div class="panel-section-title">Button Position</div>
      <div class="position-buttons">
        <button
          type="button"
          class="position-btn"
          data-position="bottom-left"
          aria-label="Bottom left"
          title="Bottom left"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
            <circle cx="7" cy="17" r="2" fill="currentColor"></circle>
          </svg>
        </button>
        <button
          type="button"
          class="position-btn"
          data-position="bottom-right"
          aria-label="Bottom right"
          title="Bottom right"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
            <circle cx="17" cy="17" r="2" fill="currentColor"></circle>
          </svg>
        </button>
        <button
          type="button"
          class="position-btn"
          data-position="top-left"
          aria-label="Top left"
          title="Top left"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
            <circle cx="7" cy="7" r="2" fill="currentColor"></circle>
          </svg>
        </button>
        <button
          type="button"
          class="position-btn"
          data-position="top-right"
          aria-label="Top right"
          title="Top right"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
            <circle cx="17" cy="7" r="2" fill="currentColor"></circle>
          </svg>
        </button>
      </div>
      <label class="hide-button-label">
        <input type="checkbox" id="hide-button-toggle" />
        Hide button (<kbd>Alt</kbd>+<kbd>A</kbd> to show)
      </label>
    </div>
  </div>

  <div class="panel-actions">
    <button type="button" class="reset-btn" id="reset-accessibility">Reset All</button>
  </div>

  <p class="panel-note">Settings saved locally</p>
</div>

<script>
  function initAccessibilityPanel() {
    const toggle = document.getElementById('accessibility-toggle');
    const panel = document.getElementById('accessibility-panel');
    const closeBtn = document.getElementById('panel-close');
    const highContrastToggle = document.getElementById('high-contrast-toggle') as HTMLInputElement;
    const textSizeDecrease = document.getElementById('text-size-decrease');
    const textSizeIncrease = document.getElementById('text-size-increase');
    const textSizeValue = document.getElementById('text-size-value');
    const reducedMotionToggle = document.getElementById(
      'reduced-motion-toggle'
    ) as HTMLInputElement;
    const textSpacingToggle = document.getElementById('text-spacing-toggle') as HTMLInputElement;
    const underlineLinksToggle = document.getElementById(
      'underline-links-toggle'
    ) as HTMLInputElement;
    const hideButtonToggle = document.getElementById('hide-button-toggle') as HTMLInputElement;
    const positionBtns = document.querySelectorAll('.position-btn');
    const resetBtn = document.getElementById('reset-accessibility');

    if (!toggle || !panel) return;

    // Text size constants
    const TEXT_SIZE_MIN = 70;
    const TEXT_SIZE_MAX = 200;
    const TEXT_SIZE_STEP = 10;
    const TEXT_SIZE_DEFAULT = 100;

    // Load saved preferences
    const savedHighContrast = localStorage.getItem('a11y-high-contrast') === 'true';
    const savedTextSize = parseInt(localStorage.getItem('a11y-text-size') || '100', 10);
    const savedReducedMotion = localStorage.getItem('a11y-reduced-motion') === 'true';
    const savedTextSpacing = localStorage.getItem('a11y-text-spacing') === 'true';
    const savedUnderlineLinks = localStorage.getItem('a11y-underline-links') === 'true';
    const savedPosition = localStorage.getItem('a11y-button-position') || 'bottom-left';
    const savedHidden = localStorage.getItem('a11y-button-hidden') === 'true';

    // Text size helper functions
    function applyTextSize(size: number) {
      const clampedSize = Math.max(TEXT_SIZE_MIN, Math.min(TEXT_SIZE_MAX, size));
      if (textSizeValue) textSizeValue.textContent = `${clampedSize}%`;

      if (clampedSize === TEXT_SIZE_DEFAULT) {
        document.documentElement.removeAttribute('data-font-size');
      } else {
        document.documentElement.setAttribute('data-font-size', String(clampedSize));
      }

      // Update button disabled states
      if (textSizeDecrease) {
        (textSizeDecrease as HTMLButtonElement).disabled = clampedSize <= TEXT_SIZE_MIN;
      }
      if (textSizeIncrease) {
        (textSizeIncrease as HTMLButtonElement).disabled = clampedSize >= TEXT_SIZE_MAX;
      }

      return clampedSize;
    }

    function getCurrentTextSize(): number {
      const attr = document.documentElement.getAttribute('data-font-size');
      return attr ? parseInt(attr, 10) : TEXT_SIZE_DEFAULT;
    }

    // Apply saved preferences
    if (savedHighContrast) {
      document.documentElement.setAttribute('data-high-contrast', 'true');
      if (highContrastToggle) highContrastToggle.checked = true;
    }

    // Apply saved text size
    applyTextSize(savedTextSize);

    if (savedReducedMotion) {
      document.documentElement.setAttribute('data-reduced-motion', 'true');
      if (reducedMotionToggle) reducedMotionToggle.checked = true;
    }

    if (savedTextSpacing) {
      document.documentElement.setAttribute('data-text-spacing', 'comfortable');
      if (textSpacingToggle) textSpacingToggle.checked = true;
    }

    if (savedUnderlineLinks) {
      document.documentElement.setAttribute('data-underline-links', 'true');
      if (underlineLinksToggle) underlineLinksToggle.checked = true;
    }

    // Apply button position
    applyPosition(savedPosition);
    updatePositionButtons(savedPosition);

    // Apply hidden state
    if (savedHidden) {
      toggle.classList.add('hidden');
      if (hideButtonToggle) hideButtonToggle.checked = true;
    }

    function applyPosition(position: string) {
      toggle.classList.remove('bottom-left', 'bottom-right', 'top-left', 'top-right');
      toggle.classList.add(position);
      panel.classList.remove('bottom-left', 'bottom-right', 'top-left', 'top-right');
      panel.classList.add(position);
    }

    function updatePositionButtons(activePosition: string) {
      positionBtns.forEach((btn) => {
        const pos = (btn as HTMLElement).dataset.position;
        btn.classList.toggle('active', pos === activePosition);
        (btn as HTMLButtonElement).setAttribute('aria-pressed', String(pos === activePosition));
      });
    }

    function closePanel() {
      toggle.setAttribute('aria-expanded', 'false');
      panel.classList.remove('visible');
      panel.setAttribute('aria-hidden', 'true');
      toggle.focus();
    }

    function openPanel() {
      toggle.setAttribute('aria-expanded', 'true');
      panel.classList.add('visible');
      panel.setAttribute('aria-hidden', 'false');
      highContrastToggle?.focus();
    }

    // Toggle panel visibility
    toggle.addEventListener('click', () => {
      const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
      if (isExpanded) {
        closePanel();
      } else {
        openPanel();
      }
    });

    // Close button
    closeBtn?.addEventListener('click', closePanel);

    // Keyboard shortcut: Alt+A to show panel (even when hidden)
    document.addEventListener('keydown', (e) => {
      if (e.altKey && e.key.toLowerCase() === 'a') {
        e.preventDefault();
        toggle.classList.remove('hidden');
        localStorage.setItem('a11y-button-hidden', 'false');
        if (hideButtonToggle) hideButtonToggle.checked = false;
        openPanel();
      }
    });

    // Close panel on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && panel.classList.contains('visible')) {
        closePanel();
      }
    });

    // Close panel when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      if (
        panel.classList.contains('visible') &&
        !panel.contains(target) &&
        !toggle.contains(target)
      ) {
        closePanel();
      }
    });

    // High contrast toggle
    highContrastToggle?.addEventListener('change', () => {
      const enabled = highContrastToggle.checked;
      if (enabled) {
        document.documentElement.setAttribute('data-high-contrast', 'true');
      } else {
        document.documentElement.removeAttribute('data-high-contrast');
      }
      localStorage.setItem('a11y-high-contrast', String(enabled));
    });

    // Text size controls
    textSizeDecrease?.addEventListener('click', () => {
      const currentSize = getCurrentTextSize();
      const newSize = applyTextSize(currentSize - TEXT_SIZE_STEP);
      localStorage.setItem('a11y-text-size', String(newSize));
    });

    textSizeIncrease?.addEventListener('click', () => {
      const currentSize = getCurrentTextSize();
      const newSize = applyTextSize(currentSize + TEXT_SIZE_STEP);
      localStorage.setItem('a11y-text-size', String(newSize));
    });

    // Reduced motion toggle
    reducedMotionToggle?.addEventListener('change', () => {
      const enabled = reducedMotionToggle.checked;
      if (enabled) {
        document.documentElement.setAttribute('data-reduced-motion', 'true');
      } else {
        document.documentElement.removeAttribute('data-reduced-motion');
      }
      localStorage.setItem('a11y-reduced-motion', String(enabled));
    });

    // Text spacing toggle
    textSpacingToggle?.addEventListener('change', () => {
      const enabled = textSpacingToggle.checked;
      if (enabled) {
        document.documentElement.setAttribute('data-text-spacing', 'comfortable');
      } else {
        document.documentElement.removeAttribute('data-text-spacing');
      }
      localStorage.setItem('a11y-text-spacing', String(enabled));
    });

    // Underline links toggle
    underlineLinksToggle?.addEventListener('change', () => {
      const enabled = underlineLinksToggle.checked;
      if (enabled) {
        document.documentElement.setAttribute('data-underline-links', 'true');
      } else {
        document.documentElement.removeAttribute('data-underline-links');
      }
      localStorage.setItem('a11y-underline-links', String(enabled));
    });

    // Position buttons
    positionBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        const position = (btn as HTMLElement).dataset.position || 'bottom-left';
        applyPosition(position);
        updatePositionButtons(position);
        localStorage.setItem('a11y-button-position', position);
      });
    });

    // Hide button toggle
    hideButtonToggle?.addEventListener('change', () => {
      const hidden = hideButtonToggle.checked;
      if (hidden) {
        toggle.classList.add('hidden');
        closePanel();
      } else {
        toggle.classList.remove('hidden');
      }
      localStorage.setItem('a11y-button-hidden', String(hidden));
    });

    // Reset button
    resetBtn?.addEventListener('click', () => {
      // Reset all settings
      document.documentElement.removeAttribute('data-high-contrast');
      document.documentElement.removeAttribute('data-font-size');
      document.documentElement.removeAttribute('data-reduced-motion');
      document.documentElement.removeAttribute('data-text-spacing');
      document.documentElement.removeAttribute('data-underline-links');

      // Reset form controls
      if (highContrastToggle) highContrastToggle.checked = false;
      applyTextSize(TEXT_SIZE_DEFAULT); // Reset text size to 100%
      if (reducedMotionToggle) reducedMotionToggle.checked = false;
      if (textSpacingToggle) textSpacingToggle.checked = false;
      if (underlineLinksToggle) underlineLinksToggle.checked = false;
      if (hideButtonToggle) hideButtonToggle.checked = false;

      // Reset position to default
      applyPosition('bottom-left');
      updatePositionButtons('bottom-left');
      toggle.classList.remove('hidden');

      // Clear localStorage
      localStorage.removeItem('a11y-high-contrast');
      localStorage.removeItem('a11y-text-size');
      localStorage.removeItem('a11y-reduced-motion');
      localStorage.removeItem('a11y-text-spacing');
      localStorage.removeItem('a11y-underline-links');
      localStorage.removeItem('a11y-button-position');
      localStorage.removeItem('a11y-button-hidden');
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAccessibilityPanel);
  } else {
    initAccessibilityPanel();
  }

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initAccessibilityPanel);
</script>
