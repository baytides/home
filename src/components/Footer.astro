---
const currentYear = new Date().getFullYear();
---

<!-- Footer -->
<footer role="contentinfo">
  <div class="container">
    <div class="footer-content">
      <div class="footer-brand">
        <picture>
          <source srcset="/assets/images/logo.webp" type="image/webp" />
          <img
            src="/assets/images/logo.png"
            alt="Bay Tides"
            class="footer-logo"
            width="60"
            height="60"
            loading="lazy"
          />
        </picture>
        <p>Using technology to protect and preserve the San Francisco Bay's environment.</p>
      </div>
      <div class="footer-links">
        <h3>Quick Links</h3>
        <ul>
          <li><a href="/about">About Us</a></li>
          <li><a href="/volunteer">Volunteer</a></li>
          <li><a href="/donate">Donate</a></li>
          <li><a href="/contact">Contact</a></li>
        </ul>
      </div>
      <div class="footer-contact">
        <h3>Connect</h3>
        <p>
          <a href="https://github.com/baytides" target="_blank" rel="noopener">
            GitHub
            <span class="sr-only">(opens in new tab)</span>
          </a>
        </p>
        <p>
          <a href="https://baynavigator.org" target="_blank" rel="noopener">
            Bay Navigator
            <span class="sr-only">(opens in new tab)</span>
          </a>
        </p>
      </div>
    </div>
    <div class="footer-bottom">
      <nav class="footer-nav" aria-label="Footer navigation">
        <ul class="footer-nav-list">
          <li><a href="/privacy">Privacy Policy</a></li>
          <li><a href="/terms">Terms of Service</a></li>
          <li><a href="/accessibility">Accessibility</a></li>
          <li><a href="/sustainability">Sustainability</a></li>
          <li><a href="/credits">Credits</a></li>
          <li><a href="/sitemap">Sitemap</a></li>
        </ul>
      </nav>
      <p class="footer-copyright">
        &copy; {currentYear} Bay Tides. All rights reserved. A 501(c)(3) nonprofit organization.
      </p>
    </div>
    <div class="footer-snowflake" id="snowflake-section">
      <div class="snowflake-content">
        <svg
          class="snowflake-icon"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 512 512"
          width="14"
          height="14"
          fill="currentColor"
          aria-hidden="true"
        >
          <path
            d="M280 24c0-13.3-10.7-24-24-24s-24 10.7-24 24v80.4l-44.7-44.7c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l78.6 78.6v66.3l-57.4-33.2-23.8-88.8c-3.4-12.8-16.6-20.4-29.4-17s-20.4 16.6-17 29.4l13 48.5-69.8-40.3c-11.5-6.6-26.2-2.7-32.8 8.8s-2.7 26.2 8.8 32.8l69.8 40.3-48.5 13c-12.8 3.4-20.4 16.6-17 29.4 3.4 12.8 16.6 20.4 29.4 17l88.8-23.8 57.4 33.2-57.4 33.2-88.8-23.8c-12.8-3.4-26 4.2-29.4 17s4.2 26 17 29.4l48.5 13-69.8 40.3c-11.5 6.6-15.4 21.3-8.8 32.8s21.3 15.4 32.8 8.8l69.8-40.3-13 48.5c-3.4 12.8 4.2 26 17 29.4s26-4.2 29.4-17l23.8-88.8 57.4-33.2v66.3l-78.6 78.6c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l44.7-44.7V488c0 13.3 10.7 24 24 24s24-10.7 24-24v-80.4l44.7 44.7c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-78.6-78.6v-66.3l57.4 33.2 23.8 88.8c3.4 12.8 16.6 20.4 29.4 17s20.4-16.6 17-29.4l-13-48.5 69.8 40.3c11.5 6.6 26.2 2.7 32.8-8.8s2.7-26.2-8.8-32.8l-69.8-40.3 48.5-13c12.8-3.4 20.4-16.6 17-29.4s-16.6-20.4-29.4-17l-88.8 23.8-57.4-33.2 57.4-33.2 88.8 23.8c12.8 3.4 26-4.2 29.4-17s-4.2-26-17-29.4l-48.5-13 69.8-40.3c11.5-6.6 15.4-21.3 8.8-32.8s-21.3-15.4-32.8-8.8l-69.8 40.3 13-48.5c3.4-12.8-4.2-26-17-29.4s-26 4.2-29.4 17l-23.8 88.8-57.4 33.2v-66.3l78.6-78.6c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0L280 104.4V24z"
          >
          </path>
        </svg>
        <span class="snowflake-text">
          <a href="https://snowflake.torproject.org/" target="_blank" rel="noopener">
            Tor Snowflake
          </a>
          proxy:
          <button
            type="button"
            id="snowflake-toggle"
            class="snowflake-toggle"
            aria-pressed="false"
            aria-label="Toggle Snowflake proxy"
          >
            <span class="toggle-label" id="snowflake-status">Enable</span>
          </button>
          <span class="snowflake-stats" id="snowflake-stats"></span>
        </span>
      </div>
    </div>
  </div>
</footer>

<!-- Hidden iframe for Snowflake proxy - only loaded when enabled -->
<iframe
  id="snowflake-iframe"
  src=""
  width="0"
  height="0"
  style="display: none; border: none;"
  title="Tor Snowflake Proxy"
>
</iframe>

<script>
  (function () {
    const STORAGE_KEY = 'snowflake-enabled';
    const SNOWFLAKE_URL = 'https://snowflake.torproject.org/embed.html';

    const toggleBtn = document.getElementById('snowflake-toggle');
    const statusLabel = document.getElementById('snowflake-status');
    const statsEl = document.getElementById('snowflake-stats');
    const iframe = document.getElementById('snowflake-iframe');

    let isEnabled = localStorage.getItem(STORAGE_KEY) === 'true';
    let sessionConnections = 0;
    let pollInterval = null;

    function updateUI() {
      toggleBtn.setAttribute('aria-pressed', String(isEnabled));
      toggleBtn.classList.toggle('active', isEnabled);
      statusLabel.textContent = isEnabled ? 'Active' : 'Enable';

      if (isEnabled && sessionConnections > 0) {
        statsEl.textContent = `· ${sessionConnections} user${sessionConnections !== 1 ? 's' : ''} helped this session`;
      } else if (isEnabled) {
        statsEl.textContent = '· Listening for connections...';
      } else {
        statsEl.textContent = '';
      }
    }

    function startProxy() {
      iframe.src = SNOWFLAKE_URL;
      iframe.style.display = 'block';
      startPolling();
    }

    function stopProxy() {
      iframe.src = '';
      iframe.style.display = 'none';
      stopPolling();
    }

    function startPolling() {
      // Poll the iframe for connection stats via postMessage
      stopPolling();
      pollInterval = setInterval(() => {
        try {
          iframe.contentWindow?.postMessage({ type: 'getStats' }, '*');
        } catch {
          // Cross-origin restrictions may prevent this
        }
      }, 5000);
    }

    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }

    // Listen for stats messages from the iframe
    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://snowflake.torproject.org') return;

      if (event.data && typeof event.data.clients === 'number') {
        sessionConnections = event.data.clients;
        updateUI();
      }
    });

    // Handle toggle click
    toggleBtn.addEventListener('click', () => {
      isEnabled = !isEnabled;
      localStorage.setItem(STORAGE_KEY, String(isEnabled));

      if (isEnabled) {
        startProxy();
      } else {
        stopProxy();
        sessionConnections = 0;
      }

      updateUI();
    });

    // Initialize on page load
    updateUI();
    if (isEnabled) {
      startProxy();
    }
  })();
</script>
