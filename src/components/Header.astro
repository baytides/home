---
import fs from 'fs';
import path from 'path';
import yaml from 'js-yaml';

const currentPath = Astro.url.pathname;

const navLinks = [
  { href: '/about', label: 'About' },
  { href: '/projects', label: 'Projects' },
  { href: '/events', label: 'Events' },
  { href: '/volunteer', label: 'Volunteer' },
  { href: '/contact', label: 'Contact' },
];

function isActive(href: string): boolean {
  if (href === '/') return currentPath === '/';
  return currentPath.startsWith(href);
}

// Load site config for Tor .onion address
let onionAddress = '';
try {
  const configPath = path.join(process.cwd(), 'src/data/site-config.yml');
  const configContent = fs.readFileSync(configPath, 'utf8');
  const config = yaml.load(configContent) as { onion_address?: string };
  onionAddress = config?.onion_address || '';
} catch {
  // Config file not found or invalid
}
---

<!-- Skip to main content link for accessibility -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- Header -->
<header role="banner">
  <div class="container">
    <div class="header-content">
      <a href="/" class="logo">
        <picture>
          <source srcset="/assets/images/logo.webp" type="image/webp" />
          <img
            src="/assets/images/logo.png"
            alt="Bay Tides Logo"
            width="50"
            height="50"
            loading="eager"
            fetchpriority="high"
          />
        </picture>
        <span class="logo-text">Bay Tides</span>
      </a>

      <button
        class="mobile-menu-toggle"
        aria-label="Toggle menu"
        aria-expanded="false"
        aria-controls="main-nav"
      >
        <span class="hamburger-icon" aria-hidden="true">&#9776;</span>
      </button>

      <nav id="main-nav" role="navigation" aria-label="Main navigation">
        <ul>
          {
            navLinks.map((link) => (
              <li>
                <a
                  href={link.href}
                  class:list={[{ active: isActive(link.href) }]}
                  aria-current={isActive(link.href) ? 'page' : undefined}
                >
                  {link.label}
                </a>
              </li>
            ))
          }
          <li>
            <a href="/donate" class="btn btn-primary">Donate</a>
          </li>
        </ul>
      </nav>

      <div class="header-tools">
        {
          onionAddress && (
            <a
              href={`http://${onionAddress}`}
              class="tool-btn onion-link"
              title="Access Bay Tides via Tor for enhanced privacy"
              aria-label="Access via Tor hidden service"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
                aria-hidden="true"
              >
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
              </svg>
              <span class="onion-label">.onion</span>
            </a>
          )
        }
        <button
          class="tool-btn"
          id="search-toggle"
          aria-label="Open search"
          aria-expanded="false"
          aria-controls="search-overlay"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
        <button
          class="tool-btn"
          id="theme-toggle"
          aria-label="Toggle dark mode"
          aria-pressed="false"
        >
          <svg
            class="sun-icon"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <circle cx="12" cy="12" r="5"></circle>
            <path
              d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
            >
            </path>
          </svg>
          <svg
            class="moon-icon"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</header>

<!-- Search Overlay -->
<div
  class="search-overlay"
  id="search-overlay"
  role="dialog"
  aria-modal="true"
  aria-label="Search Bay Tides"
  hidden
>
  <div class="search-container">
    <button class="search-close" id="search-close" aria-label="Close search">&times;</button>
    <h2 id="search-heading">Search Bay Tides</h2>
    <input
      type="text"
      class="search-input"
      id="search-input"
      placeholder="Search pages..."
      aria-labelledby="search-heading"
      autocomplete="off"
    />
    <div class="search-results" id="search-results" role="listbox" aria-label="Search results">
      <a href="/" class="search-result" role="option" aria-selected="false">
        <strong>Home</strong>
        <span>Protecting the San Francisco Bay</span>
      </a>
      <a href="/about" class="search-result" role="option" aria-selected="false">
        <strong>About Us</strong>
        <span>Our mission, who we are, and our approach</span>
      </a>
      <a href="/projects" class="search-result" role="option" aria-selected="false">
        <strong>Projects</strong>
        <span>Bay Navigator and other digital initiatives</span>
      </a>
      <a href="/volunteer" class="search-result" role="option" aria-selected="false">
        <strong>Volunteer</strong>
        <span>Tech projects, community events, environmental action</span>
      </a>
      <a href="/donate" class="search-result" role="option" aria-selected="false">
        <strong>Donate</strong>
        <span>Support digital tools and education programs</span>
      </a>
      <a href="/contact" class="search-result" role="option" aria-selected="false">
        <strong>Contact</strong>
        <span>Get in touch, send us a message</span>
      </a>
      <a href="/privacy" class="search-result" role="option" aria-selected="false">
        <strong>Privacy Policy</strong>
        <span>How we protect your data and privacy</span>
      </a>
      <a href="/terms" class="search-result" role="option" aria-selected="false">
        <strong>Terms of Service</strong>
        <span>Terms and conditions for using our website</span>
      </a>
      <a href="/events" class="search-result" role="option" aria-selected="false">
        <strong>Events</strong>
        <span>Volunteer events, workshops, and community gatherings</span>
      </a>
      <a href="/accessibility" class="search-result" role="option" aria-selected="false">
        <strong>Accessibility</strong>
        <span>Our commitment to web accessibility</span>
      </a>
    </div>
    <div id="search-status" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <p class="search-hint" aria-live="polite">
      <kbd>Esc</kbd>
      to close &middot;
      <kbd>Ctrl</kbd>
      +
      <kbd>K</kbd>
      to open
    </p>
  </div>
</div>

<script>
  // Initialize header functionality
  function initHeader() {
    const mobileToggle = document.querySelector<HTMLButtonElement>('.mobile-menu-toggle');
    const navList = document.querySelector<HTMLUListElement>('nav ul');
    const themeToggle = document.getElementById('theme-toggle');
    const searchToggle = document.getElementById('search-toggle');
    const searchOverlay = document.getElementById('search-overlay');
    const searchClose = document.getElementById('search-close');
    const searchInput = document.getElementById('search-input') as HTMLInputElement | null;
    const searchResults = document.getElementById('search-results');

    // Mobile menu
    if (mobileToggle && navList) {
      mobileToggle.addEventListener('click', function () {
        const isOpen = navList.classList.toggle('active');
        this.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });

      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (!target.closest('nav') && !target.closest('.mobile-menu-toggle')) {
          navList.classList.remove('active');
          mobileToggle.setAttribute('aria-expanded', 'false');
        }
      });
    }

    // Theme toggle
    if (themeToggle) {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
      const savedTheme = localStorage.getItem('theme');
      const isDark = savedTheme ? savedTheme === 'dark' : prefersDark.matches;

      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      themeToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');

      themeToggle.addEventListener('click', () => {
        const currentIsDark = document.documentElement.getAttribute('data-theme') === 'dark';
        document.documentElement.setAttribute('data-theme', currentIsDark ? 'light' : 'dark');
        localStorage.setItem('theme', currentIsDark ? 'light' : 'dark');
        themeToggle.setAttribute('aria-pressed', currentIsDark ? 'false' : 'true');
      });
    }

    // Search
    if (searchToggle && searchOverlay && searchInput && searchResults) {
      const results = searchResults.querySelectorAll<HTMLAnchorElement>('.search-result');
      let lastFocused: HTMLElement | null = null;

      function openSearch() {
        lastFocused = document.activeElement as HTMLElement;
        searchOverlay!.hidden = false;
        searchOverlay!.classList.add('active');
        searchToggle!.setAttribute('aria-expanded', 'true');
        searchInput!.value = '';
        results.forEach((r) => (r.style.display = 'none'));
        searchInput!.focus();
        document.body.style.overflow = 'hidden';
      }

      function closeSearch() {
        searchOverlay!.classList.remove('active');
        searchToggle!.setAttribute('aria-expanded', 'false');
        document.body.style.overflow = '';
        if (lastFocused) lastFocused.focus();
        setTimeout(() => {
          if (!searchOverlay!.classList.contains('active')) {
            searchOverlay!.hidden = true;
          }
        }, 300);
      }

      searchToggle.addEventListener('click', openSearch);
      searchClose?.addEventListener('click', closeSearch);
      searchOverlay.addEventListener('click', (e) => {
        if (e.target === searchOverlay) closeSearch();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && searchOverlay.classList.contains('active')) {
          closeSearch();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          searchOverlay.classList.contains('active') ? closeSearch() : openSearch();
        }
        // WCAG 3.0: Focus trapping in search modal
        if (e.key === 'Tab' && searchOverlay.classList.contains('active')) {
          const focusableElements = searchOverlay.querySelectorAll<HTMLElement>(
            'input, button, a:not([style*="display: none"])'
          );
          const visibleElements = Array.from(focusableElements).filter(
            (el) => el.offsetParent !== null && getComputedStyle(el).display !== 'none'
          );
          if (visibleElements.length === 0) return;
          const firstEl = visibleElements[0];
          const lastEl = visibleElements[visibleElements.length - 1];
          if (e.shiftKey && document.activeElement === firstEl) {
            e.preventDefault();
            lastEl.focus();
          } else if (!e.shiftKey && document.activeElement === lastEl) {
            e.preventDefault();
            firstEl.focus();
          }
        }
      });

      // Filter results with WCAG 3.0 screen reader announcements
      const searchStatus = document.getElementById('search-status');
      searchInput.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
        if (query === '') {
          results.forEach((r) => {
            r.style.display = 'none';
            r.setAttribute('aria-selected', 'false');
          });
          if (searchStatus) searchStatus.textContent = '';
          return;
        }
        let visibleCount = 0;
        results.forEach((r) => {
          const text = r.textContent?.toLowerCase() ?? '';
          const isMatch = text.includes(query);
          r.style.display = isMatch ? 'block' : 'none';
          r.setAttribute('aria-selected', 'false');
          if (isMatch) visibleCount++;
        });
        // Announce results count to screen readers
        if (searchStatus) {
          searchStatus.textContent =
            visibleCount === 0
              ? 'No results found'
              : `${visibleCount} result${visibleCount === 1 ? '' : 's'} found`;
        }
      });
    }
  }

  // Run on page load and after navigation
  initHeader();
  document.addEventListener('astro:after-swap', initHeader);
</script>
