---
interface Props {
  src: string;
  poster: string;
  alt: string;
  width?: number;
  height?: number;
  class?: string;
}

const { src, poster, alt, width = 600, height = 400, class: className = '' } = Astro.props;
---

<div class:list={['hover-video-container', className]} data-hover-video>
  <video
    class="hover-video"
    muted
    loop
    playsinline
    preload="metadata"
    poster={poster}
    width={width}
    height={height}
    aria-label={alt}
  >
    <source src={src} type="video/webm" />
  </video>
</div>

<style>
  .hover-video-container {
    position: relative;
    overflow: hidden;
    border-radius: var(--radius-lg, 0.75rem);
    cursor: pointer;
  }

  .hover-video {
    display: block;
    width: 100%;
    height: auto;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .hover-video-container.is-playing .hover-video {
    transform: scale(1.02);
  }

  /* Respect reduced motion preference (OS setting) */
  @media (prefers-reduced-motion: reduce) {
    .hover-video,
    .play-indicator {
      transition: none;
    }
  }

  /* Respect reduced motion preference (accessibility panel setting) */
  :global([data-reduced-motion='true']) .hover-video-container {
    /* Video will be paused via JavaScript, poster image will show */
  }

  :global([data-reduced-motion='true']) .hover-video {
    transition: none;
  }
</style>

<script>
  function initHoverVideos() {
    const containers = document.querySelectorAll('[data-hover-video]');

    // Check if reduced motion is enabled
    function isReducedMotion() {
      return (
        document.documentElement.getAttribute('data-reduced-motion') === 'true' ||
        window.matchMedia('(prefers-reduced-motion: reduce)').matches
      );
    }

    containers.forEach((container) => {
      const video = container.querySelector('video') as HTMLVideoElement;
      if (!video) return;

      let isTouch = false;
      let isPlaying = false;

      // Detect touch devices
      container.addEventListener(
        'touchstart',
        () => {
          isTouch = true;
        },
        { once: true, passive: true }
      );

      // Play on hover (desktop)
      container.addEventListener('mouseenter', () => {
        if (!isTouch && !isReducedMotion()) {
          video.play();
          container.classList.add('is-playing');
          isPlaying = true;
        }
      });

      // Pause on mouse leave (desktop)
      container.addEventListener('mouseleave', () => {
        if (!isTouch) {
          video.pause();
          container.classList.remove('is-playing');
          isPlaying = false;
        }
      });

      // Toggle on click/tap (mobile and desktop fallback)
      // Allow manual toggle even with reduced motion (user-initiated)
      container.addEventListener('click', () => {
        if (isPlaying) {
          video.pause();
          container.classList.remove('is-playing');
          isPlaying = false;
        } else {
          video.play();
          container.classList.add('is-playing');
          isPlaying = true;
        }
      });

      // Keyboard accessibility
      container.setAttribute('tabindex', '0');
      container.setAttribute('role', 'button');
      container.setAttribute('aria-label', `Play video: ${video.getAttribute('aria-label')}`);

      container.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          container.dispatchEvent(new Event('click'));
        }
      });

      // Reset when video ends (though it loops, this handles edge cases)
      video.addEventListener('ended', () => {
        container.classList.remove('is-playing');
        isPlaying = false;
      });

      // Pause video if reduced motion is enabled and video is currently playing
      if (isReducedMotion() && isPlaying) {
        video.pause();
        container.classList.remove('is-playing');
        isPlaying = false;
      }
    });
  }

  // Initialize on page load
  initHoverVideos();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:page-load', initHoverVideos);
</script>
